using System;
using System.Collections.Generic;
using System.Data.Entity.Infrastructure;
using System.Data.Entity.Migrations;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace MultivendorWebViewer.DbMigrations
{
   public class ServerDatabaseMigrator
   {
       private string ServerDatabaseConnectionString { get; set; }

       public ServerDatabaseMigrator(string serverdatabaseconnectionString)
        {
            ServerDatabaseConnectionString = serverdatabaseconnectionString;
        }

       public DbMigrationsConfiguration<MultivendorWebViewer.ServerModelContext> Configuration
       {
           get
           {
               DbMigrationsConfiguration<MultivendorWebViewer.ServerModelContext> configuration = new MultivendorWebViewer.DbMigrations.Configuration();// This can be accessed here only because the Configuration class created by migration is of type internal sealed class.
               configuration.AutomaticMigrationsEnabled = true;
               configuration.AutomaticMigrationDataLossAllowed = true;
               configuration.ContextKey = "MultivendorWebViewer.ServerModelContext"; // This should match with context key while adding migration and should be same for all migration. 
               configuration.TargetDatabase = new DbConnectionInfo(ServerDatabaseConnectionString, "System.Data.SqlClient");
               return configuration;
           }
       }

       public bool IsCurrentServerDatabaseCompatibleWithModel(System.Data.Common.DbConnection connection)
       { 
           try
            {
                using (var context = ServerModelContext.Create(connection))
                {
                    bool compatible = context.Database.CompatibleWithModel(false);
                    return compatible;
                }
            }
            catch (NotSupportedException)
            {
                return false;
            }
            catch (InvalidOperationException)
            {
                return false;
            }
       }

       public bool ResetInitialCreate(System.Data.Common.DbConnection connection,DefaultInitialCreate initialcreate)
       {
           try
           {
               using (var context = ServerModelContext.Create(connection))
               {
                   int rowupdated = context.Database.ExecuteSqlCommand("Update [dbo].[__MigrationHistory] SET [MigrationId]= initialcreate.MigrationId,[ContextKey]= initialcreate.ContextKey,[Model]=initialcreate.Model,[ProductVersion]=initialcreate.ProductVersion");

                   if (rowupdated == 1)
                   {
                       return true;
                   }
                   else
                   {
                       return false;
                   }

               }
           }
           catch (DbUpdateException)
           {
               return false;
           }
       }
   }

   public class ServerDatabaseMigrationDetail
   {

       public ServerDatabaseMigrationDetail()
       {
           AppliedMigrationNames = new List<string>();
           PendingMigraitonNames = new List<string>();
           PendingMigrationDetails = new List<PendingMigratioDetail>();
       }

       public List<string> AppliedMigrationNames { get; set; }

       public List<string> PendingMigraitonNames { get; set; }

       public bool EnableMigarationForDatabase { get; set; }

       public bool CurrentServerDatabaseCompatibleWithCurrentModel { get; set; }

       public List<PendingMigratioDetail> PendingMigrationDetails { get; set; }
   }

   public class PendingMigratioDetail
   {

       public PendingMigratioDetail()
       { 
       
       }

       public string PendingMigrationName { get; set; }

       public List<string> PendingMigrationInformation { get; set; }
   }


   public class DefaultInitialCreate
   {
       public string MigrationId { get { return "N'202207221907210_InitialCreate'"; } }

       public string ContextKey { get { return "N'MultivendorWebViewer.ServerModelContext'"; } }

       public string Model { get { return "0x1F8B0800000000000400ED5DDB6EE4B8117D0F907F10F49404B36EDB83001BA3BD0B4F7B1C183B1E3BD3DED9BC0D68896E0BD1A5A38BD78D205F9687FDA4FD8590BA50BC4AA444A9DB83C1BCB479395564158B458A55F3FBFF7E5BFEF81285CE334CB32089CFDD93A363D781B197F841BC39778BFCF1BBEFDD1F7FF8E31F96EFFDE8C5F9DCB47B8BDBA19E7176EE3EE5F9F66CB1C8BC271881EC280ABC34C992C7FCC84BA205F093C5E9F1F1DF1627270B88205C84E538CB4F459C07112CFF407FAE92D883DBBC00E14DE2C330ABCB51CDBA44753E8208665BE0C173F7A608F3E019C67E92FE021F3E07F05798BACE451800C4CB1A868FAE03E238C9418E383DFB3983EB3C4DE2CD7A8B0A4078BFDB42D4EE118419AC4770D636D71DCCF1291ECCA2EDD840794596279121E0C9DB7A76167CF74173EC92D943F3F71ECD73BEC3A32EE7F0DC5D9524F094F1C4CE56618A1BCAA7F8680D53A4264795808E1A98370E5DFE8668085224FCEF8DB34258450ACF6358E429402DEE8A8730F07E82BBFBE45F303E8F8B30A439463CA33AA60015DDA5C916A6F9EE137CACC771EDBBCE82EDB7E03B926E549F6A84D771FEF6D4753E22E2E021844421A8D958E7490AFF0E6398821CFA7720CF611A630C584EA9409DA37515A4598E7F3624911AA235E53A37E0E5038C37F9D3B9FB57B488AE8217E8370535173FC7015A81A84F9E16B08F50238996B169E97D00F38CEB7D0482706A22774F490C3F16D1035E10D392BAF0FD1466D9E4234AB27C855A4FAE7633A8DA0AA4F0F671722A09DA8C52CB83592E5ACBDB698F7F8A935FE386A3914699C1FA6699552BA4FE738E55720F5FF20E1AE8A7052297D00B22406C25F9F32E45BF6ABFEE7BD7597B00CFA76C720769EE6DEAC3F44310C3915A4B70BE69AC82563943FD047BD5DE2FBC7C2C0C72A84556BABB20A71C7A68DCEB2DD2C7C7C02BE7A46B23B4B32CDEBF6C2BB24FC1768B485CA2B9276B04FDBE0FA25E8CA6EF1A09B2989EE57F1480F1E1462E659912041EBC8EBDF01EF33B1191CB20F3F09E3A198175F1708F96962D8B87087C04CFC1A6D44BD9D2739D4F30ACB416E94375CAACCCD61762BC90725CA549F429099B5E54DD977B906E209E9044D1609D14A967C0175E866AB630E697AA09C714A921141996DAEA86E3E15B838D6DE1DB96A0A055CE0E6217A630F6BADC185DC364B804DB53E7B8EDE41286480FD2DD0DCC9F12BFE75C69CB5DAA48AED049693213B54A2196EB903D07A93AD92587F787FE3BFBE733A5396A6F959496B26DC2DBC9A6466E92DA6A9949EAB5DDB56D1E6BC0E5AC492CFC207B5999EA51E612437CB396A6D6AABBDB750436D0B00F96839DEB3153D70E64D92F49EACFBF174C6870E45675064249B405F16E8E7BCEEBECC2C38BBBA1F32E410606C43A7A864DD14C533ECB46366C7B29DD55D9EEC25408169CAD1D65BEEFC02E82F8BC33CA82D728DF8CB88296955B9001D717B55C86AC80BA6BE5DC4EEED8D6D46C9E0AB408F65E8ED8F9B00102FF22B27BAF30E0D85F8FF94BDDA2B5364C85606DD85A534F5679DA6F60F9B33E5DAEE4C5F89C7F91658917943CD0F3D41A5F7638EF63DFE9F6F32B8521CE38521A6C26B7C89A21EAE7EE5F84195242920B9616B2DD1258D41397B785B7313A13C21C3A7827C65AB40299077C515FD0BCF86C49BDD8F0D38215920C32C8419C8BB63688BD600BC24EDEB95E9A361A7345F0F99A4BB8455B0E62AF530E3A84690F5A6480D0E1A6AB6F76960B4AA574348D3AAD752B86ECE8D6A36D56F5A2831F89AA529F52FA56C0088513E76436951387AF439AECF87BD138D6AF548957E164B6B2AD4CB3BE6193FBA51A76EDF8E8E8C48EBA4859984157A473F97AAC537BEBDE690B2457F0832C811256A2333225B4A72F72FA731917613E750837E780BD680BEB43AAA4AA70285BA19263A7BEA6C8DDD05977C6411A26E57B060593CAE0F0B72EE658D0A70B2A533442BDF6638664D467D491033641D5710EF5C9510F98927719F89EA9BC66C255E55325E1060B71595F6265F5399D173E865EC39CDB8A33D7690F9182E72268100B423F640BA00C8A7B36D783477FE411A0A82D57074609D1DB1D0B5CD6BB5A153D9D6B2D93F5270B9583A094811B03755D4A35927FAEE3B5B3F7544F386F274C50F1DE733C05426914BFB9B023D41E3DAD0EAAF1AB4E9A7A67CD2173203922F23035CFA3A781BB3217E7A0E3ECA371FAA1D8AE75BE63F0F2F3CE94F2A75EC728A4AFF0E4757C792D91E978EF7D933860F4DCDDA538F80EC754C335A5386EAD55C7C0E5CE68EFD219317095D0D5FE52BFC73474D4B684DD5CD692DD9DD42D1755F4545DB05C28C2AC9637A07CE448855DD525CEBA8AB95A7DB7360F458A2A8C85C75850DE172194F224051BC8D5E22FB13E2C63692E410E1E00BEC45FF991D04CE2CB28F6D38620EFAE88126BB6D9A607FE5D7FD9947DCD5399CB763AAFD008B1ECCBC142898913BB3A38040E8420957C785B256111C56A1F56DD9B0A4EA241A8627D2C31FE8886146BF591DB48231AB12DD547AA63896898BA481F830915A291980A7D3C120F4463914203BE48C00FC314293590A4283D438935013B0C465D6680D204E430304DA188B35C70EB4B3850096B59B8A4608D8396E9E00F29A30D087BA631B7223DFDA731256C340DA3824C8D3E62153343235525FA08E4C3300D420A0F46813A8F1886BAD31E62CDF5A6A3EF343A432EC76808E58D991A870A69E114AF29D6C76A6E636820D50D8D1A4515EA42A3AADA186C67D2C816667793B630180717F7C2F0CFD5E9A3B6E12D345E5B6A22793A8E85153E5D63603348D00A633448A9C1DC91E81466D648E961D91F5BB667A8DD99D5E6504FA304D343D50D717E556EAFD9BE250643B05B98586F8E5EC53DC870AB1A83D1D36F4399E1D315FA78E283511A54AC3545AE5E0E8B9855F9C1ACCBEA0660F4B2945D6668AC4A79B76916A5DDE5439EEB330C358566AE80B8F8DA52836D8ABCC967B628523AB502F72C5C1E8C2A3639AD514FE5D9131B55612045F21E9E112329359363F5449E976355FA9A0DDD9E4C13B9E11C6D9D9A8F56E6064AD9F3B00F2B760E18CC6374D6A85015C678CD0B75096253658CA970B6C45A6364D9A984AB32C16CDF95B3806DF9CCEB4FB8D2E79B10EAE46A9FBBC25FD6D7E9FDE9D484FBF5AA097E549F3C077E79B7BECB72181DE10647EB7F87AB3028BF36370D6E401C3CC22CAFA24FDCD3E393532E1FDBE1E4465B64991F4A3E47C812A4B1F29A218426C0B3DA1B246318F022E4218B9F41EA3D815488D06881C7A41DB304CF6719B304CB2415B38429C9216609994B19668B5F2E43982D85B0AF046CFE2F5BA06CBAAF41A803B37B7D1D1685BDD7B72A1B3A5D5603F9A708BCFCD914884B891517C85205DE8C29B1BE0E517321978134C6F53AF6E1CBB9FB9FB2CF9973FDCF2F75B7374EF9E3CC3976FE3B3E5D55497C54B4A72EFB552F15F73AEAD79DF16A94667765B5F2D1EFBC0C4B3564579AE56A149B7C26AB912B50A61F62262BEB44F84C56D609F099AC6635545F939112829E95DA3B30BD91AEF1687B8E327FEABC4823F74531F79175A596A48C186A99542924C6E1D11944A6F5FF240118AF75994DB924B4F2A4B0C97838774007814FCDA321FA419977C6991E4B2AAA5C96F671C55C399690F9D4380FC12099D36972ECCEE5FE4D9C718E9AAFC318EDF160B2AF3385240DCD509593A6A519E557A852CFD800959F4AC65E8209D9642672BD07E74C69C373E6CE69C285A60CC9D332287EB3E301BD8E51728C23C75F516E01EDCC27FBCD73528551CE9DD964D65403AF20FC5B2F73899181914669B3417C03B29E1CBC9950BCA13A542BD19F81444B503DC2DECF4AD716C5AC0BFD15E411D9EFB64082D387649638EC2D41FD84E9D03604AD7C20364CC3FCD29ECB2C98087BEF993DC4A0595E60F2A41D9D393BAA8741E8D4F99020F9560721756C3E4F824BD821D0E1EA65C484AC203D24A91D492047D5C94875645B905251E70451A2F72357EB4F00AE8A65B8F2D0711E96AC470199D4C8C055C1ED93A719E195938D98161799B0F3092127C2FE75107944FA19557961D258BEF183B4962564B804E925D0462758929F9D3C205A2CCE2C396B893E862826675F9837DBF68636329587B9D4EC0CCB205B87F88417F909D4FF9B8C5C942CD8B410F87F518EA1C77808A4CD75FC9834BB2BC751D384FF2E0173E023F7E1026DB68FC0CB51B507B3ACCCEDFD198405C4AF291FA07F1DDF16F9B6C8D19061F41032B123D8E1E9A25FA62461795EDE6ECBC732368680D80CF01DF96DFCAE08429FF07D25B9BE5540604FAAFE6E816599E3EF179B1D41FA98F0EB5505544F1F7100EF61B40D1158761BAF01FEC465CE1B52D90F7003BC5DF3125B0DD22F0876DA979701D8A420CA6A8CB63FFA13E9B01FBDFCF07FE8B240313E7C0000"; } }

       public string ProductVersion { get { return "N'6.4.4'"; } }
   }
}
